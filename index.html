<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LifeTrack Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --accent-color:#5063f2;
  --bg:#f6f8fb;
  --card-border:#e6e8f2;
  --text:#0f1724;
  --muted:#6b7280;
  --font-family: "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
  --font-size:16px;
  --brightness:1;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font-family);
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  font-size:var(--font-size);
  filter:brightness(var(--brightness));
  -webkit-touch-callout:none;
  -webkit-user-select:none;
  user-select:none;
}
.container{ max-width:420px; margin:14px auto; padding:14px; }
.topbar{ display:flex; align-items:center; gap:10px; margin-bottom:12px; }
.settings-icon{
  width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center;
  background:#fff; border:1.2px solid var(--card-border); cursor:pointer; box-shadow:0 6px 16px rgba(16,24,40,0.06);
  font-size:20px;
}
.header{
  flex:1; background:linear-gradient(135deg,var(--accent-color),#7b61ff);
  color:#fff; padding:14px; border-radius:10px; text-align:center;
  box-shadow:0 12px 34px rgba(16,24,40,0.10);
}
.header h1{ margin:0; font-size:26px; font-weight:800; }
.header p{ margin:6px 0 0; font-weight:600; font-size:14px; opacity:0.95; }

.settings-panel{ display:none; background:#fff; padding:12px; border-radius:10px; border:1px solid var(--card-border); margin-bottom:12px; box-shadow:0 10px 24px rgba(16,24,40,0.06); }
.settings-row{ display:flex; flex-direction:column; gap:8px; margin-bottom:10px; text-align:left; }
.settings-row label{ font-weight:700; font-size:13px; color:var(--text); }
.font-sample{ margin-top:6px; padding:8px; border-radius:8px; background:#fbfdff; border:1px dashed #eef2ff; color:var(--muted); font-size:14px; }

.quick-actions{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin:12px 0 18px; }
.action-card{
  background:#fff; border-radius:12px; padding:14px; display:flex; align-items:center; justify-content:center;
  text-align:center; min-height:80px; cursor:pointer; border:1.2px solid var(--card-border);
  box-shadow:0 8px 20px rgba(16,24,40,0.06); font-weight:700; color:var(--text);
}
.action-card:hover{ transform:translateY(-3px); transition:transform .12s ease; box-shadow:0 18px 36px rgba(16,24,40,0.10); }

.screen{ display:none; background:#fff; padding:14px; border-radius:12px; border:1px solid var(--card-border); box-shadow:0 8px 24px rgba(16,24,40,0.06); margin-bottom:14px; text-align:center; }
.visible{ display:block; }
h3{ margin:6px 0 12px; font-size:18px; }
.sub-label{ color:var(--muted); font-size:13px; margin-bottom:8px; }

.chatbox{ height:200px; overflow:auto; text-align:left; border:1px solid #eef2ff; padding:10px; border-radius:10px; margin-bottom:10px; background:#fbfdff; }
.input-area{ display:flex; flex-direction:column; gap:8px; align-items:center; }

.btn{ width:100%; max-width:340px; padding:12px 14px; border-radius:12px; border:none; background:var(--accent-color); color:#fff; font-weight:800; cursor:pointer; box-shadow:0 8px 20px rgba(80,99,242,0.16); font-size:15px; }
input[type="text"], input[type="number"], input[type="time"], select, input[type="range"], input[type="color"]{
  width:100%; max-width:340px; padding:10px; border-radius:10px; border:1.2px solid var(--card-border); font-size:14px; margin:6px auto;
}
.todo-item{ display:flex; justify-content:space-between; align-items:center; border-radius:8px; padding:8px; border:1px solid var(--card-border); margin:8px 0; background:#fff; }
.todo-item button{ background:#ef4444; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; }

.summary{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
.summary .stat{ background:#fbfdff; padding:8px 12px; border-radius:8px; font-weight:800; color:var(--text); border:1px solid #eef2ff; font-size:14px; }
canvas{ max-width:100%; margin:8px 0; }

#tipsContainer, #medicalFileList { text-align:left; display:none; max-height:320px; overflow:auto; border:1px solid var(--card-border); padding:8px; border-radius:8px; margin-top:10px; background:#fff; }
.file-row{ display:flex; justify-content:space-between; align-items:center; padding:8px 4px; border-bottom:1px dashed #f1f5ff; gap:8px; }
.file-row button{ background:#2b6ef6; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }
.file-meta{ font-size:12px; color:var(--muted); }

@media (max-width:420px){
  .container{ padding:10px; }
  .header h1{ font-size:20px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="settings-icon" id="settingsIcon" title="App Settings">‚öôÔ∏è</div>
    <div class="header">
      <h1>LifeTrack Dashboard</h1>
      <p>Welcome User</p>
    </div>
  </div>

  <div class="settings-panel" id="settingsPanel" aria-hidden="true">
    <h3>App Settings</h3>
    <div class="settings-row">
      <label for="fontSizeRange">Font size</label>
      <input id="fontSizeRange" type="range" min="12" max="22" step="1" />
      <div class="font-sample" id="fontSample">Sample text ‚Äî font size updates live</div>
    </div>

    <div class="settings-row">
      <label for="fontSelect">Font family</label>
      <select id="fontSelect">
        <option value='"Segoe UI", Roboto, system-ui, -apple-system, sans-serif'>System UI (default)</option>
        <option value='Georgia, "Times New Roman", Times, serif'>Georgia (serif)</option>
        <option value='"Helvetica Neue", Arial, sans-serif'>Helvetica Neue / Arial</option>
        <option value='"Courier New", Courier, monospace'>Courier New (monospace)</option>
        <option value='"Trebuchet MS", "Segoe UI", sans-serif'>Trebuchet</option>
      </select>
      <div class="font-sample" id="fontFamilySample">Sample text ‚Äî font family updates live</div>
    </div>

    <div class="settings-row">
      <label for="themeColor">Theme color</label>
      <input id="themeColor" type="color" value="#5063f2" />
    </div>

    <div class="settings-row">
      <label for="brightnessRange">App brightness</label>
      <input id="brightnessRange" type="range" min="0.6" max="1.4" step="0.05" />
    </div>

    <div style="display:flex; gap:8px; margin-top:6px;">
      <button class="btn" id="saveSettingsBtn">Save</button>
      <button class="btn" id="resetSettingsBtn" style="background:#ef4444">Reset</button>
    </div>
  </div>

  <div class="quick-actions" id="actionGrid">
    <div class="action-card" onclick="showScreen('chatbot')">üí¨ Chatbot</div>
    <div class="action-card" onclick="showScreen('graph')">üìä Mood Graph</div>
    <div class="action-card" onclick="showScreen('reminders')">‚úÖ Reminders</div>
    <div class="action-card" onclick="showScreen('timer')">‚è± Timer</div>
    <div class="action-card" onclick="requestFilePicker()">üìÇ Upload Medical Files</div>
    <div class="action-card" onclick="showScreen('hydration')">üíß Hydration Monitor</div>
    <div class="action-card" onclick="showScreen('sleep')">üåô Sleep Analytics</div>
    <div class="action-card" onclick="showScreen('meals')">üçΩ Meal Tracking</div>
  </div>

  <!-- Hidden file input (fallback for browsers) -->
  <input id="medicalFile" type="file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt" multiple style="display:none"/>

  <!-- File list (populated after selection) -->
  <div id="medicalFileList"></div>

  <!-- Chatbot -->
  <div class="screen" id="chatbot">
    <h3>Simple Chatbot</h3>
    <div class="chatbox" id="chatbox"></div>
    <div class="input-area">
      <button class="btn" onclick="sendQuick('weather')">üå¶ Weather</button>
      <button class="btn" onclick="sendQuick('joke')">üòÇ Joke</button>
      <button class="btn" onclick="sendQuick('study')">üìö Study Tip</button>
    </div>
  </div>

  <!-- Mood Graph -->
  <div class="screen" id="graph">
    <h3>Mood Graph</h3>
    <p class="sub-label">Log a 1‚Äì10 mood score and track it visually.</p>
    <button class="btn" onclick="promptMood()">Enter mood</button>
    <p>Mood: <strong id="moodValue">5</strong></p>
    <canvas id="moodChart" width="360" height="160"></canvas>
  </div>

  <!-- Reminders -->
  <div class="screen" id="reminders">
    <h3>Reminders</h3>
    <input id="newReminder" type="text" placeholder="Add reminder (e.g., call family)"/>
    <button class="btn" onclick="addReminder()">Add</button>
    <div id="todoList"></div>
  </div>

  <!-- Timer -->
  <div class="screen" id="timer">
    <h3>Focus Timer</h3>
    <input id="minutes" type="number" placeholder="Minutes"/>
    <select id="alarmChoice">
      <option value="alarm1">Beep</option>
      <option value="alarm2">Marimba</option>
      <option value="alarm3">Analog bell</option>
    </select>
    <button class="btn" onclick="startTimer()">Start</button>
    <div id="countdown" style="margin-top:10px;"></div>
    <audio id="alarm1" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
    <audio id="alarm2" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2e6f3e9b4b.mp3"></audio>
    <audio id="alarm3" src="https://cdn.pixabay.com/download/audio/2021/09/30/audio_2c9b5f3b3d.mp3"></audio>
  </div>

  <!-- Hydration -->
  <div class="screen" id="hydration">
    <h3>Hydration Monitor</h3>
    <p class="sub-label">Set daily goal (ml), log intake (ml), and reminders (minutes).</p>
    <input id="waterGoal" type="number" placeholder="Daily goal (ml)" value="2000"/>
    <input id="waterIntake" type="number" placeholder="Log intake (ml)" value="250"/>
    <button class="btn" onclick="logWater()">Add intake (ml)</button>
    <div class="summary" style="margin-top:12px;">
      <div class="stat">Consumed: <span id="waterConsumed">0</span> ml</div>
      <div class="stat">Remaining: <span id="waterRemaining">2000</span> ml</div>
    </div>
    <input id="waterInterval" type="number" placeholder="Reminder interval (minutes)" value="60"/>
    <button class="btn" onclick="startWaterReminders()">Start reminders</button>
    <button class="btn" onclick="stopWaterReminders()">Stop reminders</button>
    <canvas id="waterChart" width="360" height="160"></canvas>
  </div>

  <!-- Sleep -->
  <div class="screen" id="sleep">
    <h3>Sleep Analytics</h3>
    <p class="sub-label">Log sleep/wake times. View last night and 7-day average.</p>
    <input id="sleepTime" type="time"/>
    <input id="wakeTime" type="time"/>
    <button class="btn" onclick="logSleep()">Log sleep</button>
    <p>Last duration: <strong id="lastSleepDuration">0h 0m</strong></p>
    <p>7-day average: <strong id="avgSleepDuration">0h 0m</strong></p>
    <canvas id="sleepChart" width="360" height="160"></canvas>
  </div>

  <!-- Meals -->
  <div class="screen" id="meals">
    <h3>Meal Tracking</h3>
    <p class="sub-label">Add meal name, portion (ml or g), calories. Persistent per-day.</p>
    <input id="mealName" type="text" placeholder="Meal name (e.g., Breakfast - Oats)"/>
    <input id="mealPortion" type="number" placeholder="Portion (ml or g)"/>
    <input id="mealCalories" type="number" placeholder="Calories (kcal)"/>
    <button class="btn" onclick="addMeal()">Add meal</button>

    <div class="summary" style="margin-top:12px;">
      <div class="stat">Today kcal: <span id="todayCalories">0</span></div>
      <div class="stat">Today portions: <span id="todayPortions">0</span></div>
    </div>

    <p class="muted">Recent entries</p>
    <div id="mealList"></div>

    <p class="muted" style="margin-top:12px;">Healthy eating tips</p>
    <button class="btn" onclick="toggleTips()">Show/Hide 50 Healthy Food Tips</button>
    <div id="tipsContainer"></div>

    <canvas id="mealsChart" width="360" height="160" style="margin-top:10px;"></canvas>
  </div>
</div>

<script>
/* -------------------------
   Settings persistence & UI
   ------------------------- */
const SETTINGS_KEY = 'lifetrack_settings_v2';

function loadSettings(){
  try{ const raw = localStorage.getItem(SETTINGS_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; }
}
function saveSettings(obj){ try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(obj)); }catch(e){} }
function applySettings(obj){
  if(!obj) return;
  if(obj.fontSize){ document.documentElement.style.setProperty('--font-size', obj.fontSize + 'px'); document.getElementById('fontSample').style.fontSize = obj.fontSize + 'px'; }
  if(obj.fontFamily){ document.documentElement.style.setProperty('--font-family', obj.fontFamily); document.getElementById('fontFamilySample').style.fontFamily = obj.fontFamily; }
  if(obj.themeColor){ document.documentElement.style.setProperty('--accent-color', obj.themeColor); document.getElementById('themeColor').value = obj.themeColor; }
  if(obj.brightness){ document.documentElement.style.setProperty('--brightness', obj.brightness); document.getElementById('brightnessRange').value = obj.brightness; }
}
function initSettingsUI(){
  const saved = loadSettings();
  const defaults = {
    fontSize: saved?.fontSize || 16,
    fontFamily: saved?.fontFamily || getComputedStyle(document.documentElement).getPropertyValue('--font-family').trim(),
    themeColor: saved?.themeColor || '#5063f2',
    brightness: saved?.brightness || 1
  };
  applySettings(defaults);

  document.getElementById('fontSizeRange').value = defaults.fontSize;
  document.getElementById('fontSelect').value = defaults.fontFamily;
  document.getElementById('brightnessRange').value = defaults.brightness;
  document.getElementById('fontSample').style.fontSize = defaults.fontSize + 'px';
  document.getElementById('fontFamilySample').style.fontFamily = defaults.fontFamily;

  document.getElementById('fontSizeRange').oninput = (e)=> {
    document.documentElement.style.setProperty('--font-size', e.target.value + 'px');
    document.getElementById('fontSample').style.fontSize = e.target.value + 'px';
  };
  document.getElementById('fontSelect').onchange = (e)=> {
    document.documentElement.style.setProperty('--font-family', e.target.value);
    document.getElementById('fontFamilySample').style.fontFamily = e.target.value;
  };
  document.getElementById('themeColor').oninput = (e)=> document.documentElement.style.setProperty('--accent-color', e.target.value);
  document.getElementById('brightnessRange').oninput = (e)=> document.documentElement.style.setProperty('--brightness', e.target.value);

  document.getElementById('saveSettingsBtn').onclick = ()=> {
    const obj = {
      fontSize: Number(document.getElementById('fontSizeRange').value),
      fontFamily: document.getElementById('fontSelect').value,
      themeColor: document.getElementById('themeColor').value,
      brightness: Number(document.getElementById('brightnessRange').value)
    };
    saveSettings(obj);
    applySettings(obj);
    alert('Settings saved.');
  };
  document.getElementById('resetSettingsBtn').onclick = ()=> { localStorage.removeItem(SETTINGS_KEY); location.reload(); };

  document.getElementById('settingsIcon').onclick = ()=> {
    const panel = document.getElementById('settingsPanel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    // close other screens/lists
    hideTips(); hideMedicalFiles(); document.querySelectorAll('.screen').forEach(s=>s.classList.remove('visible'));
  };
}

/* -------------------------
   Navigation helper
   ------------------------- */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible'));
  document.getElementById(id).classList.add('visible');
  hideTips(); hideMedicalFiles();
  document.getElementById('settingsPanel').style.display = 'none';
}

/* -------------------------
   App Inventor bridge helpers
   ------------------------- */
/*
  Request pattern used:
  1) requestFilePicker() -> tries in-page file input first (browser). If running inside App Inventor,
     it sends "REQUEST_FILE_PICKER" via AppInventor.setWebViewString(...) or postMessage.
  2) App Inventor must open the device picker (via extension or Activity chooser) and then set WebView.WebViewString
     to a JSON string: { "medicalFiles": [ { "name":"file.pdf", "size":12345, "type":"application/pdf", "uri": "content://..." }, ... ] }
  3) The page polls for an incoming response and handles it (display, previews). See guideline after the code.
*/

function sendToApp(json){
  try{
    if(window.AppInventor && typeof window.AppInventor.setWebViewString === 'function'){
      window.AppInventor.setWebViewString(json);
      return true;
    }
  }catch(e){}
  try{
    if(window.WebViewInterface && typeof window.WebViewInterface.postMessage === 'function'){
      window.WebViewInterface.postMessage(json);
      return true;
    }
  }catch(e){}
  try{
    if(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.AppInventor && typeof window.webkit.messageHandlers.AppInventor.postMessage === 'function'){
      window.webkit.messageHandlers.AppInventor.postMessage(json);
      return true;
    }
  }catch(e){}
  console.log('No AppInventor bridge available for sending:', json);
  return false;
}

// Poll for WebViewString-based responses if AppInventor exposes getWebViewString
// (some embedded WebView bridges expose getWebViewString or other access; this is defensive)
let pollWebViewStringTimer = null;
function startPollingWebViewString(handler, interval = 700){
  if(pollWebViewStringTimer) clearInterval(pollWebViewStringTimer);
  pollWebViewStringTimer = setInterval(()=> {
    try{
      if(window.AppInventor && typeof window.AppInventor.getWebViewString === 'function'){
        const s = window.AppInventor.getWebViewString();
        if(s && s.trim()){
          // attempt parse
          try {
            const parsed = JSON.parse(s);
            // clear WebViewString if possible (app needs to clear on its side normally)
            if(window.AppInventor && typeof window.AppInventor.setWebViewString === 'function'){
              window.AppInventor.setWebViewString('');
            }
            handler(parsed);
          } catch(e){}
        }
      }
    }catch(e){}
  }, interval);
}
function stopPollingWebViewString(){ if(pollWebViewStringTimer){ clearInterval(pollWebViewStringTimer); pollWebViewStringTimer = null; } }

/* -------------------------
   Request file picker from page / app
   ------------------------- */
let awaitingAppFiles = false;
function requestFilePicker(){
  // Try in-page picker first (works in modern browser WebView)
  const input = document.getElementById('medicalFile');
  // Safari & some WebView may block programmatic click unless user gesture; this is invoked by user tap - OK.
  try{
    input.value = '';
    input.click();
    // In many WebView environments this opens native file picker.
    // We'll still send a REQUEST to AppInventor as a fallback if no files arrive in short time.
    awaitingAppFiles = true;
    // If no files selected by in-page input within 1.2s, send REQUEST to App Inventor
    setTimeout(()=> {
      if(awaitingAppFiles){
        const req = JSON.stringify({ action: "REQUEST_FILE_PICKER" });
        sendToApp(req);
        // start polling for a response via AppInventor.getWebViewString if available
        startPollingWebViewString(handleAppReturnedFiles, 800);
      }
    }, 1200);
  }catch(e){
    // fallback: directly request AppInventor
    const req = JSON.stringify({ action: "REQUEST_FILE_PICKER" });
    sendToApp(req);
    startPollingWebViewString(handleAppReturnedFiles, 800);
  }
}

/* -------------------------
   Handle files returned from App Inventor (or in-page selection)
   ------------------------- */
let lastSelectedFiles = []; // in-memory File objects (for in-page) or metadata (from app)

/* In-page picker change handler (browser fallback) */
document.getElementById('medicalFile').addEventListener('change', function(e){
  awaitingAppFiles = false;
  stopPollingWebViewString();
  const files = Array.from(this.files || []);
  lastSelectedFiles = files;
  displaySelectedFilesFromFiles(files);
  // send metadata to AppInventor if desired
  const meta = files.map(f=>({ name:f.name, size:f.size, type:f.type }));
  sendToApp(JSON.stringify({ medicalFiles: meta }));
});

/* Handler for files returned by App Inventor via WebViewString JSON */
function handleAppReturnedFiles(obj){
  // obj expected: { medicalFiles: [ {name, size, type, uri? } ] }
  if(!obj || !obj.medicalFiles) return;
  stopPollingWebViewString();
  awaitingAppFiles = false;
  const list = obj.medicalFiles;
  // show list built from metadata (no File objects available in this case)
  displaySelectedFilesFromMeta(list);
}

/* UI to display files when we have File objects */
function displaySelectedFilesFromFiles(files){
  const list = document.getElementById('medicalFileList');
  list.style.display = 'block';
  list.innerHTML = '';
  files.forEach((f, idx) => {
    const row = document.createElement('div');
    row.className = 'file-row';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:800">${escapeHtml(f.name)}</div><div class="file-meta">${Math.round(f.size/1024)} KB ‚Ä¢ ${escapeHtml(f.type||'unknown')}</div>`;
    const right = document.createElement('div');
    const viewBtn = document.createElement('button');
    viewBtn.textContent = 'View';
    viewBtn.onclick = ()=> {
      const url = URL.createObjectURL(f);
      window.open(url, '_blank');
      setTimeout(()=>URL.revokeObjectURL(url), 60000);
    };
    const removeBtn = document.createElement('button');
    removeBtn.style.background = '#ef4444';
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = ()=> {
      files.splice(idx,1);
      if(files.length === 0){ list.innerHTML = '<div class="file-meta" style="padding:8px">No files selected.</div>'; }
      else displaySelectedFilesFromFiles(files);
      sendToApp(JSON.stringify({ medicalFiles: files.map(x=>({name:x.name,size:x.size,type:x.type})) }));
    };
    right.appendChild(viewBtn); right.appendChild(removeBtn);
    row.appendChild(left); row.appendChild(right);
    list.appendChild(row);
  });
}

/* UI to display files when we only have metadata from the app */
function displaySelectedFilesFromMeta(metaList){
  const list = document.getElementById('medicalFileList');
  list.style.display = 'block';
  list.innerHTML = '';
  metaList.forEach((m, idx) => {
    const row = document.createElement('div');
    row.className = 'file-row';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:800">${escapeHtml(m.name)}</div><div class="file-meta">${Math.round((m.size||0)/1024)} KB ‚Ä¢ ${escapeHtml(m.type||'unknown')}</div>`;
    const right = document.createElement('div');
    const infoBtn = document.createElement('button');
    infoBtn.textContent = 'Info';
    infoBtn.onclick = ()=> alert(`Name: ${m.name}\nSize: ${m.size} bytes\nType: ${m.type}\nURI: ${m.uri || 'n/a'}`);
    const removeBtn = document.createElement('button');
    removeBtn.style.background = '#ef4444';
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = ()=> {
      metaList.splice(idx,1);
      if(metaList.length === 0) list.innerHTML = '<div class="file-meta" style="padding:8px">No files selected.</div>';
      else displaySelectedFilesFromMeta(metaList);
      sendToApp(JSON.stringify({ medicalFiles: metaList }));
    };
    right.appendChild(infoBtn); right.appendChild(removeBtn);
    row.appendChild(left); row.appendChild(right);
    list.appendChild(row);
  });
}

function hideMedicalFiles(){ const list=document.getElementById('medicalFileList'); list.style.display='none'; list.innerHTML=''; }

/* -------------------------
   Chatbot (small canned responses)
   ------------------------- */
const jokes = [ "Why don‚Äôt skeletons fight? They don‚Äôt have the guts!", "Why did the math book look sad? It had too many problems.", "Why can‚Äôt your nose be 12 inches long? Because then it would be a foot!" ];
const studyTips = [ "Break study into 25-minute chunks.", "Teach to learn more." ];
function sendQuick(type){
  const chatbox = document.getElementById('chatbox');
  let userText="", reply="";
  if(type==='weather'){ userText="Weather?"; reply="Sunny and 28¬∞C (example)."; }
  else if(type==='joke'){ userText="Tell me a joke"; reply = jokes[Math.floor(Math.random()*jokes.length)]; }
  else if(type==='study'){ userText="Study tip"; reply = studyTips[Math.floor(Math.random()*studyTips.length)]; }
  chatbox.innerHTML += `<p style="margin:6px 0"><strong>You:</strong> ${escapeHtml(userText)}</p><p style="margin:6px 0"><strong>Bot:</strong> ${escapeHtml(reply)}</p>`;
  chatbox.scrollTop = chatbox.scrollHeight;
}

/* -------------------------
   Reminders (simple in-page list)
   ------------------------- */
function addReminder(){
  const text = document.getElementById('newReminder').value.trim();
  if(!text) return;
  const container = document.getElementById('todoList');
  const el = document.createElement('div');
  el.className='todo-item';
  el.innerHTML = `<span>${escapeHtml(text)}</span><div><button onclick="this.closest('.todo-item').remove()">Delete</button></div>`;
  container.prepend(el);
  document.getElementById('newReminder').value='';
}

/* -------------------------
   Mood chart
   ------------------------- */
function promptMood(){
  const value = prompt("Enter mood 1-10:","5");
  const num = Number(value);
  if(num>=1 && num<=10){ document.getElementById('moodValue').textContent = num; if(window.moodChart){ moodChart.data.datasets[0].data[0]=num; moodChart.update(); } }
  else alert("Enter a number 1-10");
}
function initMoodChart(){
  const ctx = document.getElementById('moodChart').getContext('2d');
  window.moodChart = new Chart(ctx,{ type:'bar', data:{ labels:['Mood'], datasets:[{ label:'Mood', data:[5], backgroundColor:'#5063f2' }] }, options:{ scales:{ y:{ beginAtZero:true, max:10 } }, plugins:{ legend:{ display:false } } } });
}

/* -------------------------
   Timer
   ------------------------- */
function startTimer(){
  const minutes = parseInt(document.getElementById('minutes').value,10);
  if(isNaN(minutes)||minutes<=0) return alert('Enter minutes');
  let seconds = minutes*60;
  const countdown = document.getElementById('countdown');
  const alarm = document.getElementById('alarm1');
  const t = setInterval(()=> {
    const m = Math.floor(seconds/60), s = seconds%60;
    countdown.textContent = `${m}:${s<10?'0':''}${s}`;
    if(--seconds < 0){ clearInterval(t); alarm.currentTime=0; alarm.play(); countdown.textContent = 'Done'; }
  },1000);
}

/* -------------------------
   Hydration (ml)
   ------------------------- */
let waterConsumed = 0;
let waterReminderTimer = null;
let waterChart = null;
function updateWaterUI(){
  const goal = Number(document.getElementById('waterGoal').value || 0);
  document.getElementById('waterConsumed').textContent = waterConsumed;
  document.getElementById('waterRemaining').textContent = Math.max(goal - waterConsumed, 0);
  if(waterChart){ waterChart.data.datasets[0].data = [waterConsumed, Math.max(goal - waterConsumed, 0)]; waterChart.update(); }
}
function logWater(){
  const intake = Number(document.getElementById('waterIntake').value || 0);
  if(intake <= 0) return alert('Enter ml value');
  waterConsumed += intake;
  localStorage.setItem('waterConsumed', String(waterConsumed));
  updateWaterUI();
}
function startWaterReminders(){
  const mins = Number(document.getElementById('waterInterval').value || 0);
  if(mins <= 0) return alert('Enter minutes interval');
  if(waterReminderTimer) clearInterval(waterReminderTimer);
  waterReminderTimer = setInterval(()=> { alert(`Hydration reminder: drink ${document.getElementById('waterIntake').value || 250} ml`); }, mins*60000);
  alert('Hydration reminders started');
}
function stopWaterReminders(){ if(waterReminderTimer){ clearInterval(waterReminderTimer); waterReminderTimer = null; alert('Hydration reminders stopped'); } }
function initWaterChart(){
  const ctx = document.getElementById('waterChart').getContext('2d');
  const goal = Number(document.getElementById('waterGoal').value || 2000);
  waterChart = new Chart(ctx,{ type:'doughnut', data:{ labels:['Consumed','Remaining'], datasets:[{ data:[0,goal], backgroundColor:['#34d399','#e6e8f2'] }] }, options:{ cutout:'60%', plugins:{ legend:{ position:'bottom' } } } });
  try{ waterConsumed = Number(localStorage.getItem('waterConsumed')||0); }catch(e){ waterConsumed = 0; }
  updateWaterUI();
}

/* -------------------------
   Sleep analytics
   ------------------------- */
const sleepLogs = [];
let sleepChart = null;
function logSleep(){
  const s = document.getElementById('sleepTime').value;
  const w = document.getElementById('wakeTime').value;
  if(!s||!w) return alert('Select both times');
  const [sh,sm] = s.split(':').map(Number);
  const [wh,wm] = w.split(':').map(Number);
  let start = sh*60 + sm, end = wh*60 + wm;
  if(end <= start) end += 24*60;
  const mins = end - start, hours = mins/60;
  document.getElementById('lastSleepDuration').textContent = `${Math.floor(hours)}h ${Math.round((hours%1)*60)}m`;
  const today = new Date().toISOString().slice(0,10);
  sleepLogs.push({ date: today, hours });
  const last7 = sleepLogs.slice(-7);
  const avg = last7.reduce((a,b)=>a+b.hours,0)/last7.length;
  document.getElementById('avgSleepDuration').textContent = `${Math.floor(avg)}h ${Math.round((avg%1)*60)}m`;
  updateSleepChart();
}
function initSleepChart(){
  const ctx = document.getElementById('sleepChart').getContext('2d');
  sleepChart = new Chart(ctx,{ type:'bar', data:{ labels:[], datasets:[{ label:'Hours', data:[], backgroundColor:'#7c5cff' }] }, options:{ scales:{ y:{ beginAtZero:true, max:12 } }, plugins:{ legend:{ display:false } } } });
}
function updateSleepChart(){
  if(!sleepChart) return;
  const last7 = sleepLogs.slice(-7);
  sleepChart.data.labels = last7.map(l=>l.date.slice(5));
  sleepChart.data.datasets[0].data = last7.map(l=>Number(l.hours.toFixed(2)));
  sleepChart.update();
}

/* -------------------------
   Meal tracking (fixed)
   ------------------------- */
function getTodayKey(){ return 'meals_' + (new Date().toISOString().slice(0,10)); }
function loadMeals(){ try{ return JSON.parse(localStorage.getItem(getTodayKey())||'[]'); }catch(e){ return []; } }
function saveMeals(list){ localStorage.setItem(getTodayKey(), JSON.stringify(list)); }
function renderMeals(){
  const list = loadMeals();
  const container = document.getElementById('mealList');
  container.innerHTML = '';
  let totalCalories = 0, totalPortions = 0;
  list.slice().reverse().forEach(m=>{
    const el = document.createElement('div');
    el.className = 'todo-item';
    el.innerHTML = `<div style="text-align:left"><strong>${escapeHtml(m.name)}</strong><div class="file-meta">${escapeHtml(m.portion)} unit ‚Ä¢ ${escapeHtml(m.calories)} kcal</div></div>
      <div><button onclick="removeMeal(${m.id})">Delete</button></div>`;
    container.appendChild(el);
    totalCalories += Number(m.calories || 0);
    totalPortions += Number(m.portion || 0);
  });
  document.getElementById('todayCalories').textContent = totalCalories;
  document.getElementById('todayPortions').textContent = totalPortions;
  updateMealsChart(list);
}
function addMeal(){
  const name = document.getElementById('mealName').value.trim();
  const portion = Number(document.getElementById('mealPortion').value || 0);
  const calories = Number(document.getElementById('mealCalories').value || 0);
  if(!name) return alert('Enter meal name');
  const list = loadMeals();
  const entry = { id: Date.now(), name, portion, calories, ts: Date.now() };
  list.push(entry);
  saveMeals(list);
  document.getElementById('mealName').value=''; document.getElementById('mealPortion').value=''; document.getElementById('mealCalories').value='';
  renderMeals();
}
function removeMeal(id){
  let list = loadMeals();
  list = list.filter(m=>m.id !== id);
  saveMeals(list);
  renderMeals();
}
let mealsChart = null;
function initMealsChart(){
  const ctx = document.getElementById('mealsChart').getContext('2d');
  mealsChart = new Chart(ctx,{ type:'pie', data:{ labels:['Consumed kcal','Remaining kcal'], datasets:[{ data:[0,2000], backgroundColor:['#ff9f43','#e9eefb'] }] }, options:{ plugins:{ legend:{ position:'bottom' } } });
  renderMeals();
}
function updateMealsChart(list){
  if(!mealsChart) return;
  const total = (list || loadMeals()).reduce((s,m)=>s+(Number(m.calories)||0),0);
  const target = 2000;
  mealsChart.data.datasets[0].data = [total, Math.max(target - total, 0)];
  mealsChart.update();
}

/* -------------------------
   Meal tips
   ------------------------- */
const mealTips = [
  "Eat a colorful plate ‚Äî fruits and vegetables of different colors.",
  "Include lean protein with every meal.",
  "Choose whole grains over refined grains.",
  "Snack on nuts and seeds instead of chips.",
  "Drink water before meals to avoid overeating.",
  "Cook more at home to control ingredients.",
  "Keep portion sizes moderate.",
  "Include healthy fats like olive oil or avocado.",
  "Limit sugary drinks; choose water or tea.",
  "Eat fiber-rich foods for digestion.",
  "Plan meals to avoid impulse choices.",
  "Start day with a balanced breakfast.",
  "Combine protein and carbs for steady energy.",
  "Add vegetables to sandwiches and omelettes.",
  "Use herbs and spices instead of excess salt.",
  "Choose grilled or steamed over fried.",
  "Pick fruit or yogurt for dessert.",
  "Use legumes as economical protein.",
  "Rotate proteins for variety.",
  "Read labels for trans fat and sugars.",
  "Try zucchini noodles as pasta substitute.",
  "Make quick salads with seeds and greens.",
  "Use hummus or Greek yogurt as dips.",
  "Keep healthy snacks visible.",
  "Reduce processed meats.",
  "Balance treats with healthier meals.",
  "Have protein snack before workouts.",
  "Avoid heavy late-night meals.",
  "Add chia or flax to smoothies.",
  "Use brown rice or quinoa.",
  "Include fermented foods for gut health.",
  "Avoid skipping meals to reduce overeating.",
  "Batch cook and freeze portions.",
  "Prefer baking or air-frying to deep frying.",
  "Choose whole fruit over juice.",
  "Add leafy greens daily.",
  "Pick unsweetened nut butters.",
  "Chew slowly and be mindful.",
  "Limit sugary cereals.",
  "Use beans and lentils regularly.",
  "Dressings: citrus and vinegar over creams.",
  "Try meatless meals several times weekly.",
  "Rotate seasonal vegetables.",
  "Keep pre-cut veggies for quick snacks.",
  "Watch portions of calorie-dense foods.",
  "Aim for carbs, protein, fats, fiber each meal.",
  "Consult a nutritionist for personalized advice."
];
function toggleTips(){
  const c = document.getElementById('tipsContainer');
  if(c.style.display === 'block'){ c.style.display='none'; c.innerHTML=''; return; }
  c.innerHTML = mealTips.map((t,i)=>`<div style="padding:8px 6px;border-bottom:1px solid #f1f5ff"><strong>${i+1}.</strong> ${escapeHtml(t)}</div>`).join('');
  c.style.display = 'block';
}
function hideTips(){ const c=document.getElementById('tipsContainer'); c.style.display='none'; c.innerHTML=''; }

/* -------------------------
   Utils & Init
   ------------------------- */
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

window.onload = function(){
  initMoodChart();
  initWaterChart();
  initSleepChart();
  initMealsChart();
  initSettingsUI();
  showScreen('chatbot');
  try{ waterConsumed = Number(localStorage.getItem('waterConsumed')||0); }catch(e){ waterConsumed = 0; }
  updateWaterUI();
  renderMeals();
};
</script>
</body>
</html>
